---

# These are necessary for proper quota usage on Corral
galaxydbservers_group_groups:
  - name: G-803372
    gid: 803372
    local: true

# NOTE: running this on a fresh instance would precreate the postgres user with system-determined uid and gid, which is
# not ideal (on EL the package seems to create with uid/gid 26).
galaxydbservers_group_users:
  - name: postgres
    groups: G-803372
    local: true
    system: true

galaxydbservers_group_templates:
  - src: templates/stats/galaxy_db_slurp.sh.j2
    dest: /usr/local/bin/galaxy_db_slurp.sh
    owner: root
    group: root
    mode: '0755'

telegraf_plugins_extra:
  galaxy_db_slurp:
    plugin: "exec"
    config:
      - commands = ["/usr/local/bin/galaxy_db_slurp.sh"]
      - timeout = "120s"
      - data_format = "influx"
      - interval = "1m"
      - '[inputs.exec.tags]'
      - '  influxdb_database = "{{ galaxy_instance_codename }}_sql"'
  galaxy_tools_likely_broken_1w:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery tool-likely-broken --short-tool-id 1'"]
      - timeout = "180s"
      - data_format = "influx"
      - interval = "15m"
      - '[inputs.exec.tags]'
      - '  influxdb_database = "{{ galaxy_instance_codename }}_sql"'
  galaxy_queue_by_tool:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery queue --by tool'"]
      - timeout = "180s"
      - data_format = "influx"
      - interval = "1m"
      - '[inputs.exec.tags]'
      - '  influxdb_database = "{{ galaxy_instance_codename }}_sql"'
  galaxy_queue_by_destination:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery queue --by destination'"]
      - timeout = "180s"
      - data_format = "influx"
      - interval = "1m"
      - '[inputs.exec.tags]'
      - '  influxdb_database = "{{ galaxy_instance_codename }}_sql"'
  #galaxy_queue_by_user:
  #  plugin: "exec"
  #  config:
  #    - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery queue --by user'"]
  #    - timeout = "180s"
  #    - data_format = "influx"
  #    - interval = "1m"
  #    - '[inputs.exec.tags]'
  #    - '  influxdb_database = "{{ galaxy_instance_codename }}_sql"'

  # Some custom galaxy monitoring stuff
  galaxy_uploaded:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery upload-gb-in-past-hour"]
      - timeout = "120s"
      - data_format = "influx"
      - interval = "1h"
  galaxy_lastlog:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin uwsgi lastlog"]
      - timeout = "15s"
      - data_format = "influx"
      - interval = "15s"
  galaxy_jobs_queued:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery jobs-queued"]
      - timeout = "15s"
      - data_format = "influx"
      - interval = "1m"
  galaxy_jobs_queued_internal:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery jobs-queued-internal-by-handler"]
      - timeout = "15s"
      - data_format = "influx"
      - interval = "1m"
  galaxy_jobs_queue_overview:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery queue-overview --short-tool-id"]
      - timeout = "30s"
      - data_format = "influx"
      - interval = "1m"
  galaxy_oidc:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery users-with-oidc"]
      - timeout = "15s"
      - data_format = "influx"
      - interval = "1m"
  galaxy_workflow:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery workflow-invocation-status"]
      - timeout = "15s"
      - data_format = "influx"
      - interval = "1m"
  galaxy_workflow_totals:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin iquery workflow-invocation-totals"]
      - timeout = "15s"
      - data_format = "influx"
      - interval = "1m"
  galaxy_active_users:
    plugin: "exec"
    config:
      - commands = ["/bin/bash -c 'PGDATABASE=galaxy_{{ galaxy_instance_codename }} /usr/local/bin/gxadmin uwsgi active-users"]
      - timeout = "15s"
      - data_format = "influx"
      - interval = "1m"

gxadmin_dir: /usr/local/lib/gxadmin
gxadmin_bin_dir: /usr/local/bin
