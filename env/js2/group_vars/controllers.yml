---

slurm_scale_user: slurm
slurm_ssh_key: "{{ openstack_privatekeys.slurm }}"

os_image: Featured-RockyLinux9
os_flavor: m3.quad

os_security_groups:
  - default
  - usegalaxy-control

os_floating_ips:
  - "{{ lookup('dig', inventory_hostname) }}"

cvmfs_quota_limit: 1024

controllers_group_authorized_key_users:
  #- name: centos
  #  authorized: "{{ galaxy_admin_users }} + ['marius_van_den_beek']"
  - name: g2test
    authorized: "{{ galaxy_team_users }}"
  - name: g2main
    authorized: "{{ galaxy_team_users }}"

controllers_group_packages:
  - vim
  - git
  - tmpwatch
  - pdsh
  # Pulsar deps
  #- python39
  #- python39-devel
  - '@development tools'
  #- python-virtualenv
  - libffi-devel
  - libcurl-devel
  - nss-devel
  - openssl-devel
  #- slurm-drmaa
  # this probably won't work until after Slurm is installed
  - https://github.com/natefoo/slurm-drmaa/releases/download/1.1.4/slurm-drmaa-1.1.4-22.05.el9.x86_64.rpm


controllers_group_files:
  - src: files/admin/pdsh-up
    dest: /usr/local/bin/pdsh-up
    mode: "0755"
    owner: root
    group: root
  - src: files/admin/tmpwatch-auto
    dest: /usr/local/bin/tmpwatch-auto
    mode: "0755"
    owner: root
    group: root

controllers_group_templates:
  - src: templates/telegraf/slurm_slurp.sh.j2
    dest: /usr/local/bin/slurm_slurp.sh
    owner: root
    group: root
    mode: '0755'

controllers_group_directories:
  #- path: /var/lib/slurm
  #  mode: "0755"
  - path: /srv/pulsar/test
    owner: g2test
    group: G-803372
  - path: /srv/pulsar/test/log
    owner: g2test
    group: G-803372
  - path: /srv/pulsar/main
    owner: g2main
    group: G-803372
  - path: /srv/pulsar/main/log
    owner: g2main
    group: G-803372
  # see comment in links
  #- path: /galaxy-repl
  #- path: /galaxy-repl/main

controllers_group_crontabs:
  - id: clean_scratch
    name: Clean Test Scratch
    user: g2test
    minute: 05,20,35,50
    job: /usr/local/bin/tmpwatch-auto /jetstream2/scratch/test/jobs
  - id: clean_scratch
    name: Clean Main Scratch
    user: g2main
    minute: 00,15,30,45
    job: /usr/local/bin/tmpwatch-auto /jetstream2/scratch/main/jobs
  - id: clean_amqp_consume
    name: Clean Test AMQP consume dir
    user: g2test
    minute: "0"
    hour: "2"
    job: "/usr/bin/tmpwatch 7d /srv/pulsar/test/var/persisted_data/amqp_ack-jetstream2/consume"
  - id: clean_amqp_consume
    name: Clean Main AMQP consume dir
    user: g2main
    minute: "30"
    hour: "2"
    job: "/usr/bin/tmpwatch 7d /srv/pulsar/main/var/persisted_data/amqp_ack-jetstream2/consume"

telegraf_agent_hostname: "{{ inventory_hostname }}"
# not sure why but it's establishing connections very slowly
telegraf_influxdb_output_timeout: "15s"
telegraf_plugins_extra:
  slurm_slurp:
    plugin: "exec"
    config:
      - commands = ["/usr/local/bin/slurm_slurp.sh"]
      - timeout = "120s"
      - data_format = "influx"
      - interval = "1m"
  http_response:
    config:
      # TODO: how does this name get updated in dns?
      - urls = ["http://cvmfs1-js2.js2local/cvmfs/info/v1/meta.json"]
      - http_proxy = "http://localhost:3128"
      - response_status_code = 200
      - interface = "lo"
  tmpwatch_auto_runtime:
    plugin: "exec"
    config:
      - commands = ["bash -c 'echo tmpwatch_auto_mutex age=$(($(date +%s) - $(stat -c %Y /tmp/tmpwatch-auto-g2main.lock 2>/dev/null || date +%s)))'"]
      - timeout = "10s"
      - data_format = "influx"
      - interval = "30s"
  pulsar_staging_fds:
    plugin: "file"
    config:
      # via the manual rocky@jetstream2 crontab:
      # * * * * * umask 022; sudo lsof -p $(pgrep -u g2main pulsar-main) | grep /jetstream2/scratch | awk '{print $4}' | tr -d '0-9' | sort | uniq -c | awk '{print $2"="$1}' | xargs echo pulsar_staging_fds > /tmp/pulsar-staging-fds-g2main.txt
      - files = ["/tmp/pulsar-staging-fds-g2main.txt"]
      - data_format = "influx"
      - interval = "1m"

slurm_slurp_cluster_name: "{{ slurm_cluster_name }}"
slurm_slurp_partitions:
  - gpu-small
  - gxit
  - tpv
  - vgp
