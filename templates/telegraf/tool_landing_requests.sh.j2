#!/bin/bash
set -euo pipefail

# Query tool_landing_request table for metrics
# Output in InfluxDB line protocol format for Telegraf

PGDATABASE="galaxy_{{ galaxy_instance_codename }}"

# Total tool landing requests
total=$(psql -d "$PGDATABASE" -t -A -c "SELECT COUNT(*) FROM tool_landing_request;")
echo "tool_landing_requests_total value=${total}i"

# Requests by day (last 30 days)
psql -d "$PGDATABASE" -t -A -F',' <<EOF | while IFS=',' read -r day count; do
SELECT
    DATE(create_time) as day,
    COUNT(*) as count
FROM tool_landing_request
WHERE create_time >= NOW() - INTERVAL '30 days'
GROUP BY DATE(create_time)
ORDER BY day;
EOF
    echo "tool_landing_requests_daily,day=${day} count=${count}i"
done

# Requests by tool_id (top 10)
psql -d "$PGDATABASE" -t -A -F',' <<EOF | while IFS=',' read -r tool_id count; do
SELECT
    COALESCE(tool_id, 'null') as tool_id,
    COUNT(*) as count
FROM tool_landing_request
WHERE create_time >= NOW() - INTERVAL '7 days'
GROUP BY tool_id
ORDER BY count DESC
LIMIT 10;
EOF
    tool_id_escaped=$(echo "$tool_id" | sed 's/[,= ]/\\&/g')
    echo "tool_landing_requests_by_tool,tool_id=${tool_id_escaped} count=${count}i"
done

# Public vs Private requests (last 24 hours)
psql -d "$PGDATABASE" -t -A -F',' <<EOF | while IFS=',' read -r visibility count; do
SELECT
    CASE WHEN public THEN 'public' ELSE 'private' END as visibility,
    COUNT(*) as count
FROM tool_landing_request
WHERE create_time >= NOW() - INTERVAL '24 hours'
GROUP BY public;
EOF
    echo "tool_landing_requests_visibility,visibility=${visibility} count=${count}i"
done

# Requests with user vs anonymous (last 24 hours)
psql -d "$PGDATABASE" -t -A -F',' <<EOF | while IFS=',' read -r user_type count; do
SELECT
    CASE WHEN user_id IS NULL THEN 'anonymous' ELSE 'registered' END as user_type,
    COUNT(*) as count
FROM tool_landing_request
WHERE create_time >= NOW() - INTERVAL '24 hours'
GROUP BY (user_id IS NULL);
EOF
    echo "tool_landing_requests_user_type,user_type=${user_type} count=${count}i"
done

# Recent activity (last 1 hour, 24 hours, 7 days)
recent_1h=$(psql -d "$PGDATABASE" -t -A -c "SELECT COUNT(*) FROM tool_landing_request WHERE create_time >= NOW() - INTERVAL '1 hour';")
recent_24h=$(psql -d "$PGDATABASE" -t -A -c "SELECT COUNT(*) FROM tool_landing_request WHERE create_time >= NOW() - INTERVAL '24 hours';")
recent_7d=$(psql -d "$PGDATABASE" -t -A -c "SELECT COUNT(*) FROM tool_landing_request WHERE create_time >= NOW() - INTERVAL '7 days';")

echo "tool_landing_requests_recent,period=1h value=${recent_1h}i"
echo "tool_landing_requests_recent,period=24h value=${recent_24h}i"
echo "tool_landing_requests_recent,period=7d value=${recent_7d}i"
