#!/usr/bin/env bash
set -euo pipefail

if [[ -z ${1:-} ]]; then
    echo "usage: $0 LISTSPEC [OWNER]"
    exit 1
fi

LISTSPEC="$1"
OWNER="${2:-{{ mailman3_config.mailman.site_owner }}}"

echo 'Updating list settings...'
PYTHONPATH={{ mailman3_install_dir | quote }}/lib mailman withlist -r close_list -l "$LISTSPEC" | sed 's/^/  /'

echo 'Updating list owners...'
echo 'Previous owners:'
mailman members --role owner "$LISTSPEC" | sed 's/^/  /'
echo 'Previous moderators:'
mailman members --role moderator "$LISTSPEC" | sed 's/^/  /'

if [[ $(mailman members --count-only --role moderator "$LISTSPEC") -ne 0 ]]; then
    echo 'Removing previous moderators...'
    mailman members --email-only --role moderator "$LISTSPEC" | grep -v "^${OWNER}$" | tr '[:upper:]' '[:lower:]' | xargs printf " --delete %s" | xargs mailman admins "$LISTSPEC" --role moderator
fi
echo "Adding closed list owner: $OWNER"
mailman members --email-only --role owner "$LISTSPEC" | grep -q "^${OWNER}$" || mailman admins "$LISTSPEC" --role owner --add "$OWNER"
echo 'Removing previous owners...'
mailman members --email-only --role owner "$LISTSPEC" | grep -v "^${OWNER}$" | tr '[:upper:]' '[:lower:]' | xargs --no-run-if-empty printf " --delete %s" | xargs --no-run-if-empty mailman admins "$LISTSPEC" --role owner
echo 'Done'
