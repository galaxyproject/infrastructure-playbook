##
## This file is maintained by Ansible - CHANGES WILL BE OVERWRITTEN
##

# Redirect www -> root
server {
    listen       *:443 ssl;
    server_name  www.usegalaxy.org;

    return 301 https://usegalaxy.org$request_uri;
}

# Define web upstream
upstream galaxy {
    least_conn;
    server {{ lookup('dig', groups['galaxy_main_web_servers'][0]) }}:8080;
    server {{ lookup('dig', groups['galaxy_main_web_servers'][0]) }}:8081;
    server {{ lookup('dig', groups['galaxy_main_staging_servers'][0]) }}:8080 backup;
    server {{ lookup('dig', groups['galaxy_main_staging_servers'][0]) }}:8081 backup;
}

# Define staging upstreams
upstream galaxy_staging {
    least_conn;
    server {{ lookup('dig', groups['galaxy_main_staging_servers'][0]) }}:8080;
    server {{ lookup('dig', groups['galaxy_main_staging_servers'][0]) }}:8081;
    server {{ lookup('dig', groups['galaxy_main_web_servers'][0]) }}:8080 backup;
    server {{ lookup('dig', groups['galaxy_main_web_servers'][0]) }}:8081 backup;
}

upstream tusd {
    server {{ lookup('dig', groups['galaxy_main_web_servers'][0]) }}:{{ galaxy_tusd_port }};
    server {{ lookup('dig', groups['galaxy_main_staging_servers'][0]) }}:{{ galaxy_tusd_port }} backup;
}

# Main server
server {
    listen       *:443 ssl http2 default_server;
    server_name  usegalaxy.org *.usegalaxy.org;

    access_log  /var/log/nginx/main.access.log;
    error_log   /var/log/nginx/main.error.log;

    # usegalaxy.org link shortening
    include {{ nginx_conf_dir }}/usegalaxy_rewrites.conf;
    include {{ nginx_conf_dir }}/usegalaxy_proxy.conf;

}

server {
    listen       *:443 ssl http2;
    server_name  staging.usegalaxy.org;

    access_log  /var/log/nginx/staging.access.log;
    error_log   /var/log/nginx/staging.error.log;

    # upstreams set this to a reasonable value
    client_max_body_size 0;

    location / {
        proxy_pass         http://galaxy;
        proxy_redirect     off;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/jobs/[^/]+/files {
        try_files false @galaxy_staging;
    }

    location /_job_files {
        try_files false @galaxy_staging;
    }

    # since this is internal it should be unnecessary
    #location /_upload_job_files_done {
    #}

    location @galaxy_staging {
        proxy_pass         http://galaxy_staging;
        proxy_redirect     off;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

# Domain-based Galaxy Interactive Tools (GxITs)
server {
    listen       *:443 ssl http2;
    server_name  *.interactivetool.usegalaxy.org;

    # Enable HSTS (age is 180 days)
    add_header Strict-Transport-Security "max-age=15552000; includeSubdomains";

    access_log  /var/log/nginx/main-gxit-proxy.access.log;
    error_log   /var/log/nginx/main-gxit-proxy.error.log;

    location / {
        proxy_redirect      off;
        proxy_http_version  1.1;
        proxy_set_header    Host        $host;
        proxy_set_header    X-Real-IP   $remote_addr;
        proxy_set_header    Upgrade     $http_upgrade;
        proxy_set_header    Connection  "upgrade";
        proxy_pass          http://{{ gxit_proxy_host }}:{{ gxit_proxy_port }};
    }

    # error docs
    #error_page  502 503 504 /error/502/index.shtml;
    #error_page  413         /error/413/index.html;
    #location /error {
    #    ssi on;
    #    root /srv/nginx/galaxy;
    #}

}

# vim: set filetype=nginx
