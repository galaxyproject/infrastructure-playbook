---

- name: Install virtualenv (yum)
  yum:
    pkg: "{{ item }}"
  when: ansible_os_family == "RedHat"
  with_items:
    - python-virtualenv
    - ipython

- name: Create virtualenv for elastic components
  pip:
    name: "{{ item }}"
    virtualenv: "/opt/slurm_cloud_provision"
    state: latest
  with_items:
    - pip
    - setuptools
    - cython

- name: Install specific Ansible version in the venv
  pip:
    name: ansible
    virtualenv: "/opt/slurm_cloud_provision"
    version: 2.1.5.0

- name: Download Pyslurm
  git:
    repo: https://github.com/PySlurm/pyslurm
    version: 16.05.5
    dest: /opt/pyslurm

- name: Install Pyslurm
  shell: "{{ item }}"
  args:
    chdir: /opt/pyslurm
  with_items:
    - /opt/slurm_cloud_provision/bin/python setup.py build
    - /opt/slurm_cloud_provision/bin/python setup.py install

- name: Download SlurmScale
  git:
    repo: https://github.com/afgane/slurmscale
    dest: /opt/slurm_cloud_provision/slurmscale
  ignore_errors: yes

- name: Install SlurmScale
  shell: /opt/slurm_cloud_provision/bin/python setup.py install
  args:
    chdir: /opt/slurm_cloud_provision/slurmscale

- name: Copy SlurmScale config file
  copy:
    remote_src: True
    src: /opt/slurm_cloud_provision/slurmscale/slurmscale.ini.sample
    dest: /opt/slurm_cloud_provision/slurmscale/slurmscale.ini

- name: Copy this playbook
  synchronize:  # sync is much faster than copy but requires chown task below
    src: "{{ playbook_dir }}/../"
    dest: /opt/slurm_cloud_provision/infrastructure-playbook/

- name: Place vault pass
  copy:
    src: "../jetstream_common/files/elasticity/vp"
    dest: /root/.vault_pass
    mode: "0600"

- name: Place CloudBridge config
  copy:
    src: "../jetstream_common/files/elasticity/cloudbridge"
    dest: /root/.cloudbridge
    mode: "0600"

- name: Ensure root's .ssh dir exists
  file:
    path: /root/.ssh
    state: directory

- name: Place PK
  copy:
    src: "../jetstream_common/files/elasticity/elasticity_kp"
    dest: /root/.ssh/id_rsa
    mode: "0600"
