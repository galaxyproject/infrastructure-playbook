---

# This only needed for zfs recv
- name: Set sys_fs_import for backup users
  ansible.builtin.lineinfile:
    dest: /etc/user_attr
    backup: "yes"
    line: "{{ item }}::::type=normal;defaultpriv=basic,sys_fs_import"
    regexp: "^{{ item }}:.*"
  loop: "{{ zfs_backup_users | default([]) }}"

- name: Fetch rrsync
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/RsyncProject/rsync/v3.3.0/support/rrsync
    checksum: sha1:a421157138ebc319e4a7e62f61fb209e178372a3
    dest: "{{ rrsync_path }}"
    mode: "0755"

- name: Deploy zfs-snapshot.py
  ansible.builtin.copy:
    src: zfs-snapshot.py
    dest: "{{ zfs_snapshot_path }}"
    mode: "0755"

- name: Deploy zfs-prunesnaps.bash
  ansible.builtin.copy:
    src: zfs-prunesnaps.bash
    dest: "{{ zfs_prunesnaps_path }}"
    mode: "0755"

- name: Create zfs-prunesnaps.conf directory
  ansible.builtin.file:
    path: "{{ zfs_prunesnaps_config_path | dirname }}"
    state: directory

- name: Deploy zfs-prunesnaps.conf
  ansible.builtin.template:
    src: zfs-prunesnaps.conf.j2
    dest: "{{ zfs_prunesnaps_config_path }}"
    mode: "0644"

- name: Configure zfs-prunesnaps logging
  ansible.builtin.lineinfile:
    path: /opt/local/etc/rsyslog.conf
    line: "local0.debug	/var/log/prunesnaps.log"
    backup: true
  notify:
    - Reload syslog
